<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Mario Game - Ù„Ø¹Ø¨Ø© Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙŠÙˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #87CEEB 0%, #98FB98 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            direction: rtl;
        }
        
        #gameContainer {
            position: relative;
            border: 3px solid #333;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        #gameUI {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
            display: flex;
            gap: 20px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
        }
        
        #gameCanvas {
            display: block;
            background: #5C94FC;
        }
        
        .menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 200;
        }
        
        .menu h1, .menu h2 {
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .menu button {
            margin: 10px;
            padding: 15px 30px;
            font-size: 18px;
            background: #FF6B35;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .menu button:hover {
            background: #FF8C42;
            transform: scale(1.05);
        }
        
        .hidden {
            display: none !important;
        }
        
        .menu p {
            margin: 10px 0;
            font-size: 16px;
        }
        
        .level-btn {
            padding: 10px 20px;
            font-size: 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .level-btn:hover {
            background: #45a049;
            transform: scale(1.05);
        }
        
        .level-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .shop-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        .shop-item h3 {
            margin: 0 0 10px 0;
            color: #FFD700;
        }
        
        .shop-item p {
            margin: 10px 0;
            font-size: 14px;
            color: #ccc;
        }
        
        .buy-btn {
            padding: 8px 16px;
            font-size: 14px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .buy-btn:hover {
            background: #1976D2;
            transform: scale(1.05);
        }
        
        .buy-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="gameUI">
            <div id="score">Ø§Ù„Ù†Ù‚Ø§Ø·: 0</div>
            <div id="lives">Ø§Ù„Ø£Ø±ÙˆØ§Ø­: 3</div>
            <div id="timer">Ø§Ù„ÙˆÙ‚Øª: 400</div>
            <div id="coins">Ø§Ù„Ø¹Ù…Ù„Ø§Øª: 0</div>
        </div>
        <canvas id="gameCanvas" width="1024" height="576"></canvas>
        <div id="gameMenu" class="menu">
            <h1>ğŸ„ Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙŠÙˆ ğŸ„</h1>
            <button id="startBtn">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
            <button id="levelsBtn">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±Ø­Ù„Ø©</button>
            <button id="shopMenuBtn">Ø§Ù„Ù…ØªØ¬Ø±</button>
            <button id="instructionsBtn">Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª</button>
        </div>
        <div id="gameOver" class="menu hidden">
            <h2>Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©! ğŸ’€</h2>
            <p id="finalScore">Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: 0</p>
            <button id="restartBtn">Ø§Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
            <button id="menuBtn">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>
        <div id="instructions" class="menu hidden">
            <h2>Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª ğŸ“‹</h2>
            <p>ğŸ® Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø³Ù‡Ù… Ø£Ùˆ WASD Ù„Ù„Ø­Ø±ÙƒØ©</p>
            <p>â¬†ï¸ Ù…Ø³Ø§ÙØ© Ø£Ùˆ Ø³Ù‡Ù… Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ù‚ÙØ²</p>
            <p>ğŸ”¥ Ø§Ø¶ØºØ· X Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ÙƒØ±Ø§Øª Ø§Ù„Ù†Ø§Ø±ÙŠØ© (Ù…Ø¹ Ø²Ù‡Ø±Ø© Ø§Ù„Ù†Ø§Ø±)</p>
            <p>ğŸª™ Ø§Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ù…Ù„Ø§Øª ÙˆØ§Ù„ÙØ·Ø±</p>
            <p>ğŸ‘¾ ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡ Ø£Ùˆ Ø§Ù‚ÙØ² Ø¹Ù„ÙŠÙ‡Ù…</p>
            <p>ğŸ ÙˆØµÙ„ Ù„Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ù„Ù„ÙÙˆØ²</p>
            <p>ğŸ ÙˆØµÙ„ Ø¥Ù„Ù‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø³ØªÙˆÙ‰</p>
            <button id="backBtn">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
        </div>
        
        <div id="levelSelect" class="menu hidden">
            <h2>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±Ø­Ù„Ø© ğŸ¯</h2>
            <div id="levelButtons" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px;">
                <button class="level-btn" data-level="1">Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1</button>
                <button class="level-btn" data-level="2">Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2</button>
                <button class="level-btn" data-level="3">Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3</button>
                <button class="level-btn" data-level="4">Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4</button>
                <button class="level-btn" data-level="5">Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5</button>
                <button class="level-btn" data-level="6">Ø§Ù„Ù…Ø±Ø­Ù„Ø© 6</button>
            </div>
            <button id="backToMenuBtn">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
        </div>
        
        <div id="shop" class="menu hidden">
            <h2>Ø§Ù„Ù…ØªØ¬Ø± ğŸ›’</h2>
            <div id="playerCoins" style="margin-bottom: 20px; font-size: 20px; color: #FFD700;">Ø§Ù„Ø¹Ù…Ù„Ø§Øª: 0</div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 20px;">
                <div class="shop-item">
                    <h3>ğŸ„ ÙØ·Ø± Ø¥Ø¶Ø§ÙÙŠ</h3>
                    <p>ÙŠØ¬Ø¹Ù„Ùƒ ÙƒØ¨ÙŠØ±Ø§Ù‹ ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø±Ø­Ù„Ø©</p>
                    <button class="buy-btn" data-item="extraMushroom" data-price="50">Ø´Ø±Ø§Ø¡ - 50 Ø¹Ù…Ù„Ø©</button>
                </div>
                <div class="shop-item">
                    <h3>â¤ï¸ Ø­ÙŠØ§Ø© Ø¥Ø¶Ø§ÙÙŠØ©</h3>
                    <p>ÙŠØ¶ÙŠÙ Ø­ÙŠØ§Ø© ÙˆØ§Ø­Ø¯Ø©</p>
                    <button class="buy-btn" data-item="extraLife" data-price="100">Ø´Ø±Ø§Ø¡ - 100 Ø¹Ù…Ù„Ø©</button>
                </div>
                <div class="shop-item">
                    <h3>âš¡ Ø³Ø±Ø¹Ø© ÙØ§Ø¦Ù‚Ø©</h3>
                    <p>ÙŠØ²ÙŠØ¯ Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ø±ÙƒØ©</p>
                    <button class="buy-btn" data-item="speedBoost" data-price="75">Ø´Ø±Ø§Ø¡ - 75 Ø¹Ù…Ù„Ø©</button>
                </div>
                <div class="shop-item">
                    <h3>ğŸ¦˜ Ù‚ÙØ²Ø© Ø¹Ø§Ù„ÙŠØ©</h3>
                    <p>ÙŠØ²ÙŠØ¯ Ù‚ÙˆØ© Ø§Ù„Ù‚ÙØ²</p>
                    <button class="buy-btn" data-item="jumpBoost" data-price="60">Ø´Ø±Ø§Ø¡ - 60 Ø¹Ù…Ù„Ø©</button>
                </div>
                <div class="shop-item">
                    <h3>ğŸ›¡ï¸ Ø¯Ø±Ø¹ Ø§Ù„Ø­Ù…Ø§ÙŠØ©</h3>
                    <p>Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡ Ù„ÙØªØ±Ø©</p>
                    <button class="buy-btn" data-item="shield" data-price="80">Ø´Ø±Ø§Ø¡ - 80 Ø¹Ù…Ù„Ø©</button>
                </div>
                <div class="shop-item">
                    <h3>ğŸª™ Ù…Ø¶Ø§Ø¹Ù Ø§Ù„Ø¹Ù…Ù„Ø§Øª</h3>
                    <p>ÙŠØ¶Ø§Ø¹Ù Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©</p>
                    <button class="buy-btn" data-item="coinMultiplier" data-price="120">Ø´Ø±Ø§Ø¡ - 120 Ø¹Ù…Ù„Ø©</button>
                </div>
                <div class="shop-item">
                    <h3>ğŸŒ¸ Ø²Ù‡Ø±Ø© Ø§Ù„Ù†Ø§Ø±</h3>
                    <p>ØªÙ…Ù†Ø­Ùƒ Ø§Ù„Ù‚Ø¯Ø±Ø© Ø¹Ù„Ù‰ Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ÙƒØ±Ø§Øª Ø§Ù„Ù†Ø§Ø±ÙŠØ©</p>
                    <button class="buy-btn" data-item="fireFlower" data-price="150">Ø´Ø±Ø§Ø¡ - 150 Ø¹Ù…Ù„Ø©</button>
                </div>
            </div>
            <button id="backFromShopBtn">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
        </div>
        
        <div id="levelComplete" class="menu hidden">
            <h2>Ù…Ø¨Ø±ÙˆÙƒ! ğŸ‰</h2>
            <p id="levelScore">Ø§Ù„Ù†Ù‚Ø§Ø·: 0</p>
            <p id="coinsEarned">Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©: 0</p>
            <button id="nextLevelBtn">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©</button>
            <button id="shopBtn">Ø§Ù„Ù…ØªØ¬Ø±</button>
            <button id="levelSelectBtn">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±Ø­Ù„Ø©</button>
        </div>
    </div>

    <script>
        // Game variables
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Game state
        let gameState = 'menu'; // menu, playing, gameOver, levelSelect, shop, levelComplete
        let score = 0;
        let lives = 3;
        let coins = 0;
        let timer = 400;
        let camera = { x: 0, y: 0 };
        let currentLevel = 1;
        let maxLevel = 1;
        let totalCoins = parseInt(localStorage.getItem('totalCoins')) || 0;
        
        // Advanced game systems
        let weather = 'sunny'; // sunny, rainy, snowy, windy
        let timeOfDay = 'day'; // day, sunset, night
        let backgroundOffset = 0;
        let movingPlatforms = [];
        let fireballs = [];
        let bosses = [];
        let achievements = JSON.parse(localStorage.getItem('achievements')) || [];
        let statistics = JSON.parse(localStorage.getItem('statistics')) || {
            totalJumps: 0,
            enemiesDefeated: 0,
            coinsCollected: 0,
            levelsCompleted: 0,
            timePlayed: 0
        };
        
        // Player upgrades
        let playerUpgrades = {
            extraMushroom: false,
            speedBoost: false,
            jumpBoost: false,
            shield: false,
            coinMultiplier: false,
            fireFlower: false
        };
        
        // Input handling
        const keys = {};
        
        // Game objects
        let mario = null;
        let enemies = [];
        let platforms = [];
        let powerUps = [];
        let coinItems = [];
        let particles = [];
        
        // Mario class
        class Mario {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.width = 32;
                this.height = 32;
                this.velocityX = 0;
                this.velocityY = 0;
                this.speed = playerUpgrades.speedBoost ? 7 : 5;
                this.jumpPower = playerUpgrades.jumpBoost ? 18 : 15;
                this.onGround = false;
                this.direction = 1; // 1 for right, -1 for left
                this.big = playerUpgrades.extraMushroom;
                this.fireFlower = playerUpgrades.fireFlower;
                this.invulnerable = 0;
                this.animFrame = 0;
                this.animTimer = 0;
                this.shieldTime = playerUpgrades.shield ? 300 : 0;
                this.lastFireTime = 0;
                this.walkCycle = 0;
                this.isWalking = false;
                
                if (this.big) {
                    this.height = 48;
                }
            }
            
            shootFireball() {
                const fireball = new Fireball(
                    this.x + (this.direction > 0 ? this.width : 0),
                    this.y + this.height / 2,
                    this.direction
                );
                fireballs.push(fireball);
            }
            
            update() {
                // Handle input
                this.isWalking = false;
                if (keys['ArrowLeft'] || keys['a'] || keys['A']) {
                    this.velocityX = -this.speed;
                    this.direction = -1;
                    this.isWalking = true;
                } else if (keys['ArrowRight'] || keys['d'] || keys['D']) {
                    this.velocityX = this.speed;
                    this.direction = 1;
                    this.isWalking = true;
                } else {
                    this.velocityX *= 0.8; // Friction
                }
                
                if ((keys[' '] || keys['ArrowUp'] || keys['w'] || keys['W']) && this.onGround) {
                    this.velocityY = -this.jumpPower;
                    this.onGround = false;
                    statistics.totalJumps++;
                }
                
                // Fireball shooting
                if ((keys['x'] || keys['X']) && !this.fireballPressed) {
                    if (this.fireFlower && Date.now() - this.lastFireTime > 300) {
                        fireballs.push(new Fireball(
                            this.x + (this.facingRight ? this.width : 0),
                            this.y + this.height/2,
                            this.facingRight ? 1 : -1
                        ));
                        this.lastFireTime = Date.now();
                        this.fireballPressed = true;
                    }
                }
                
                if (!(keys['x'] || keys['X'])) {
                    this.fireballPressed = false;
                }
                
                // Apply gravity
                this.velocityY += 0.8;
                
                // Update position
                this.x += this.velocityX;
                this.y += this.velocityY;
                
                // Ground collision
                if (this.y > canvas.height - this.height - 50) {
                    this.y = canvas.height - this.height - 50;
                    this.velocityY = 0;
                    this.onGround = true;
                }
                
                // Platform collision
                this.checkPlatformCollision();
                
                // Enemy collision
                this.checkEnemyCollision();
                
                // Power-up collision
                this.checkPowerUpCollision();
                
                // Coin collision
                this.checkCoinCollision();
                
                // Update camera
                camera.x = this.x - canvas.width / 2;
                if (camera.x < 0) camera.x = 0;
                
                // Update invulnerability and shield
                if (this.invulnerable > 0) {
                    this.invulnerable--;
                }
                if (this.shieldTime > 0) {
                    this.shieldTime--;
                }
                
                // Animation
                this.animTimer++;
                if (this.animTimer > 10) {
                    this.animFrame = (this.animFrame + 1) % 4;
                    this.animTimer = 0;
                }
                
                // Death check
                if (this.y > canvas.height + 100) {
                    this.die();
                }
            }
            
            checkPlatformCollision() {
                for (let platform of platforms) {
                    if (this.x < platform.x + platform.width &&
                        this.x + this.width > platform.x &&
                        this.y < platform.y + platform.height &&
                        this.y + this.height > platform.y) {
                        
                        // Top collision (landing on platform)
                        if (this.velocityY > 0 && this.y < platform.y) {
                            this.y = platform.y - this.height;
                            this.velocityY = 0;
                            this.onGround = true;
                        }
                        // Bottom collision
                        else if (this.velocityY < 0 && this.y > platform.y) {
                            this.y = platform.y + platform.height;
                            this.velocityY = 0;
                        }
                        // Side collisions
                        else if (this.velocityX > 0) {
                            this.x = platform.x - this.width;
                        } else if (this.velocityX < 0) {
                            this.x = platform.x + platform.width;
                        }
                    }
                }
            }
            
            checkEnemyCollision() {
                for (let i = enemies.length - 1; i >= 0; i--) {
                    let enemy = enemies[i];
                    if (this.x < enemy.x + enemy.width &&
                        this.x + this.width > enemy.x &&
                        this.y < enemy.y + enemy.height &&
                        this.y + this.height > enemy.y) {
                        
                        if (this.velocityY > 0 && this.y < enemy.y) {
                            // Jump on enemy
                            enemies.splice(i, 1);
                            this.velocityY = -10;
                            score += 100;
                            statistics.enemiesDefeated++;
                            createParticles(enemy.x + enemy.width/2, enemy.y + enemy.height/2, '#FF6B35');
                            checkAchievements();
                        } else if (this.invulnerable === 0 && this.shieldTime === 0) {
                            // Take damage
                            if (this.big) {
                                this.big = false;
                                this.height = 32;
                                this.invulnerable = 120;
                            } else {
                                this.die();
                            }
                        }
                    }
                }
            }
            
            checkPowerUpCollision() {
                for (let i = powerUps.length - 1; i >= 0; i--) {
                    let powerUp = powerUps[i];
                    if (this.x < powerUp.x + powerUp.width &&
                        this.x + this.width > powerUp.x &&
                        this.y < powerUp.y + powerUp.height &&
                        this.y + this.height > powerUp.y) {
                        
                        powerUps.splice(i, 1);
                        if (powerUp.type === 'mushroom') {
                            if (!this.big) {
                                this.big = true;
                                this.height = 48;
                                score += 1000;
                            }
                        } else if (powerUp.type === 'fireFlower') {
                            this.fireFlower = true;
                            this.big = true;
                            this.height = 48;
                            score += 1500;
                        }
                        createParticles(powerUp.x + powerUp.width/2, powerUp.y + powerUp.height/2, '#FFD700');
                    }
                }
            }
            
            checkCoinCollision() {
                for (let i = coinItems.length - 1; i >= 0; i--) {
                    let coin = coinItems[i];
                    if (this.x < coin.x + coin.width &&
                        this.x + this.width > coin.x &&
                        this.y < coin.y + coin.height &&
                        this.y + this.height > coin.y) {
                        
                        coinItems.splice(i, 1);
                        let coinValue = playerUpgrades.coinMultiplier ? 2 : 1;
                        coins += coinValue;
                        totalCoins += coinValue;
                        statistics.coinsCollected += coinValue;
                        score += 200 * coinValue;
                        createParticles(coin.x + coin.width/2, coin.y + coin.height/2, '#FFD700');
                        checkAchievements();
                        
                        if (coins >= 100) {
                            coins = 0;
                            lives++;
                        }
                    }
                }
            }
            
            die() {
                lives--;
                if (lives <= 0) {
                    gameState = 'gameOver';
                    document.getElementById('finalScore').textContent = `Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: ${score}`;
                    document.getElementById('gameOver').classList.remove('hidden');
                } else {
                    // Respawn
                    this.x = 50;
                    this.y = 100;
                    this.velocityX = 0;
                    this.velocityY = 0;
                    this.big = false;
                    this.height = 32;
                    this.invulnerable = 180;
                }
            }
            
            draw() {
                ctx.save();
                
                // Flicker when invulnerable
                if (this.invulnerable > 0 && Math.floor(this.invulnerable / 5) % 2) {
                    ctx.globalAlpha = 0.5;
                }
                
                // Draw Mario with advanced animations
                let marioColor = this.fireFlower ? '#FFFFFF' : (this.big ? '#FF0000' : '#FF6B35');
                ctx.fillStyle = marioColor;
                
                // Walking animation
                if (this.isWalking && this.onGround) {
                    this.walkCycle += 0.3;
                    let bounce = Math.sin(this.walkCycle) * 2;
                    ctx.fillRect(this.x - camera.x, this.y + bounce, this.width, this.height);
                } else {
                    ctx.fillRect(this.x - camera.x, this.y, this.width, this.height);
                }
                
                // Draw face
                ctx.fillStyle = '#FFDBAC';
                ctx.fillRect(this.x - camera.x + 8, this.y + 8, 16, 16);
                
                // Draw hat (different color for fire flower)
                ctx.fillStyle = this.fireFlower ? '#FFFFFF' : '#FF0000';
                ctx.fillRect(this.x - camera.x + 4, this.y + 4, 24, 12);
                
                // Draw mustache
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(this.x - camera.x + 12, this.y + 16, 8, 4);
                
                // Draw overalls
                ctx.fillStyle = this.fireFlower ? '#FF0000' : '#0066CC';
                ctx.fillRect(this.x - camera.x + 6, this.y + 20, 20, this.height - 20);
                
                // Draw fire flower effect
                if (this.fireFlower) {
                    ctx.strokeStyle = '#FF4500';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(this.x - camera.x + this.width/2, this.y + this.height/2, this.width/2 + 3, 0, Math.PI * 2);
                    ctx.stroke();
                }
                
                // Draw shield effect
                if (this.shieldTime > 0) {
                    ctx.strokeStyle = '#00FFFF';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(this.x - camera.x + this.width/2, this.y + this.height/2, this.width/2 + 8, 0, Math.PI * 2);
                    ctx.stroke();
                }
                
                ctx.restore();
            }
        }
        
        // Enemy class
        class Enemy {
            constructor(x, y, type = 'goomba') {
                this.x = x;
                this.y = y;
                this.width = 32;
                this.height = 32;
                this.velocityX = -1;
                this.velocityY = 0;
                this.type = type;
                this.onGround = false;
            }
            
            update() {
                // Apply gravity
                this.velocityY += 0.8;
                
                // Update position
                this.x += this.velocityX;
                this.y += this.velocityY;
                
                // Ground collision
                if (this.y > canvas.height - this.height - 50) {
                    this.y = canvas.height - this.height - 50;
                    this.velocityY = 0;
                    this.onGround = true;
                }
                
                // Platform collision
                for (let platform of platforms) {
                    if (this.x < platform.x + platform.width &&
                        this.x + this.width > platform.x &&
                        this.y < platform.y + platform.height &&
                        this.y + this.height > platform.y) {
                        
                        if (this.velocityY > 0 && this.y < platform.y) {
                            this.y = platform.y - this.height;
                            this.velocityY = 0;
                            this.onGround = true;
                        }
                    }
                }
                
                // Reverse direction at edges
                if (this.onGround) {
                    let nextX = this.x + this.velocityX * 10;
                    let onPlatform = false;
                    
                    for (let platform of platforms) {
                        if (nextX + this.width > platform.x && nextX < platform.x + platform.width &&
                            this.y + this.height >= platform.y && this.y + this.height <= platform.y + 10) {
                            onPlatform = true;
                            break;
                        }
                    }
                    
                    if (!onPlatform && this.y + this.height >= canvas.height - 60) {
                        onPlatform = true;
                    }
                    
                    if (!onPlatform) {
                        this.velocityX *= -1;
                    }
                }
            }
            
            draw() {
                ctx.fillStyle = this.type === 'goomba' ? '#8B4513' : '#228B22';
                ctx.fillRect(this.x - camera.x, this.y, this.width, this.height);
                
                // Draw eyes
                ctx.fillStyle = '#000';
                ctx.fillRect(this.x - camera.x + 8, this.y + 8, 4, 4);
                ctx.fillRect(this.x - camera.x + 20, this.y + 8, 4, 4);
                
                // Draw mouth
                ctx.fillRect(this.x - camera.x + 12, this.y + 20, 8, 2);
            }
        }
        
        // Platform class
        class Platform {
            constructor(x, y, width, height, type = 'brick') {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.type = type;
            }
            
            draw() {
                if (this.type === 'brick') {
                    ctx.fillStyle = '#8B4513';
                } else if (this.type === 'pipe') {
                    ctx.fillStyle = '#228B22';
                } else {
                    ctx.fillStyle = '#654321';
                }
                
                ctx.fillRect(this.x - camera.x, this.y, this.width, this.height);
                
                // Draw brick pattern
                if (this.type === 'brick') {
                    ctx.strokeStyle = '#654321';
                    ctx.lineWidth = 2;
                    for (let i = 0; i < this.width; i += 32) {
                        for (let j = 0; j < this.height; j += 16) {
                            ctx.strokeRect(this.x - camera.x + i, this.y + j, 32, 16);
                        }
                    }
                }
            }
        }
        
        // PowerUp class
        class PowerUp {
            constructor(x, y, type = 'mushroom') {
                this.x = x;
                this.y = y;
                this.width = 24;
                this.height = 24;
                this.type = type;
                this.velocityX = 2;
                this.velocityY = 0;
            }
            
            update() {
                this.velocityY += 0.5;
                this.x += this.velocityX;
                this.y += this.velocityY;
                
                // Ground collision
                if (this.y > canvas.height - this.height - 50) {
                    this.y = canvas.height - this.height - 50;
                    this.velocityY = 0;
                }
                
                // Platform collision
                for (let platform of platforms) {
                    if (this.x < platform.x + platform.width &&
                        this.x + this.width > platform.x &&
                        this.y < platform.y + platform.height &&
                        this.y + this.height > platform.y) {
                        
                        if (this.velocityY > 0 && this.y < platform.y) {
                            this.y = platform.y - this.height;
                            this.velocityY = 0;
                        } else if (this.velocityX > 0) {
                            this.velocityX = -2;
                        } else {
                            this.velocityX = 2;
                        }
                    }
                }
            }
            
            draw() {
                if (this.type === 'mushroom') {
                    // Mushroom cap
                    ctx.fillStyle = '#FF0000';
                    ctx.fillRect(this.x - camera.x, this.y, this.width, this.height * 0.6);
                    
                    // White spots
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(this.x - camera.x + 4, this.y + 4, 4, 4);
                    ctx.fillRect(this.x - camera.x + 16, this.y + 4, 4, 4);
                    
                    // Mushroom stem
                    ctx.fillStyle = '#FFDBAC';
                    ctx.fillRect(this.x - camera.x + 8, this.y + this.height * 0.6, 8, this.height * 0.4);
                } else if (this.type === 'fireFlower') {
                    // Fire flower petals
                    ctx.fillStyle = '#FF4500';
                    ctx.fillRect(this.x - camera.x + 2, this.y + 2, 20, 8);
                    ctx.fillRect(this.x - camera.x + 8, this.y - 2, 8, 20);
                    
                    // Center
                    ctx.fillStyle = '#FFD700';
                    ctx.fillRect(this.x - camera.x + 8, this.y + 8, 8, 8);
                    
                    // Stem
                    ctx.fillStyle = '#228B22';
                    ctx.fillRect(this.x - camera.x + 10, this.y + 16, 4, 8);
                }
            }
        }
        
        // Coin class
        class Coin {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.width = 20;
                this.height = 20;
                this.animFrame = 0;
                this.animTimer = 0;
            }
            
            update() {
                this.animTimer++;
                if (this.animTimer > 15) {
                    this.animFrame = (this.animFrame + 1) % 4;
                    this.animTimer = 0;
                }
            }
            
            draw() {
                ctx.fillStyle = '#FFD700';
                ctx.fillRect(this.x - camera.x, this.y, this.width, this.height);
                
                // Draw coin symbol
                ctx.fillStyle = '#FFA500';
                ctx.fillRect(this.x - camera.x + 6, this.y + 4, 8, 12);
                ctx.fillStyle = '#FFD700';
                ctx.fillRect(this.x - camera.x + 8, this.y + 6, 4, 8);
            }
        }
        
        // Fireball class
        class Fireball {
            constructor(x, y, direction) {
                this.x = x;
                this.y = y;
                this.width = 16;
                this.height = 16;
                this.velocityX = direction * 8;
                this.velocityY = -2;
                this.direction = direction;
                this.bounces = 0;
                this.maxBounces = 3;
                this.life = 180;
            }
            
            update() {
                this.x += this.velocityX;
                this.y += this.velocityY;
                this.velocityY += 0.4; // Gravity
                
                // Ground bounce
                if (this.y > canvas.height - 70) {
                    this.y = canvas.height - 70;
                    this.velocityY = -8;
                    this.bounces++;
                    if (this.bounces >= this.maxBounces) {
                        this.life = 0;
                    }
                }
                
                // Platform collision
                for (let platform of platforms) {
                    if (this.x < platform.x + platform.width &&
                        this.x + this.width > platform.x &&
                        this.y < platform.y + platform.height &&
                        this.y + this.height > platform.y) {
                        
                        if (this.velocityY > 0 && this.y < platform.y) {
                            this.y = platform.y - this.height;
                            this.velocityY = -8;
                            this.bounces++;
                        }
                    }
                }
                
                // Enemy collision
                for (let i = enemies.length - 1; i >= 0; i--) {
                    let enemy = enemies[i];
                    if (this.x < enemy.x + enemy.width &&
                        this.x + this.width > enemy.x &&
                        this.y < enemy.y + enemy.height &&
                        this.y + this.height > enemy.y) {
                        
                        enemies.splice(i, 1);
                        this.life = 0;
                        score += 200;
                        statistics.enemiesDefeated++;
                        createParticles(enemy.x + enemy.width/2, enemy.y + enemy.height/2, '#FF4500');
                    }
                }
                
                this.life--;
            }
            
            draw() {
                ctx.fillStyle = '#FF4500';
                ctx.fillRect(this.x - camera.x, this.y, this.width, this.height);
                
                // Fire effect
                ctx.fillStyle = '#FFD700';
                ctx.fillRect(this.x - camera.x + 4, this.y + 4, 8, 8);
                
                // Flame trail
                ctx.fillStyle = '#FF6600';
                ctx.fillRect(this.x - camera.x + 2, this.y + 2, 12, 12);
            }
        }
        
        // Moving Platform class
        class MovingPlatform extends Platform {
            constructor(x, y, width, height, startX, endX, speed = 1) {
                super(x, y, width, height, 'moving');
                this.startX = startX;
                this.endX = endX;
                this.speed = speed;
                this.direction = 1;
                this.originalX = x;
            }
            
            update() {
                this.x += this.speed * this.direction;
                
                if (this.x <= this.startX || this.x >= this.endX) {
                    this.direction *= -1;
                }
                
                // Move Mario with platform if he's on it
                if (mario && mario.onGround && 
                    mario.x < this.x + this.width &&
                    mario.x + mario.width > this.x &&
                    mario.y + mario.height >= this.y &&
                    mario.y + mario.height <= this.y + 10) {
                    mario.x += this.speed * this.direction;
                }
            }
            
            draw() {
                ctx.fillStyle = '#9932CC';
                ctx.fillRect(this.x - camera.x, this.y, this.width, this.height);
                
                // Moving platform indicator
                ctx.fillStyle = '#FFD700';
                ctx.fillRect(this.x - camera.x + 2, this.y + 2, this.width - 4, 4);
            }
        }
        
        // Boss class
        class Boss {
            constructor(x, y, type = 'bowser') {
                this.x = x;
                this.y = y;
                this.width = 64;
                this.height = 64;
                this.velocityX = -0.5;
                this.velocityY = 0;
                this.type = type;
                this.health = 3;
                this.maxHealth = 3;
                this.attackTimer = 0;
                this.invulnerable = 0;
                this.onGround = false;
            }
            
            update() {
                // Basic AI movement
                this.velocityY += 0.8;
                this.x += this.velocityX;
                this.y += this.velocityY;
                
                // Ground collision
                if (this.y > canvas.height - this.height - 50) {
                    this.y = canvas.height - this.height - 50;
                    this.velocityY = 0;
                    this.onGround = true;
                }
                
                // Attack pattern
                this.attackTimer++;
                if (this.attackTimer > 120) {
                    this.attack();
                    this.attackTimer = 0;
                }
                
                // Change direction occasionally
                if (Math.random() < 0.01) {
                    this.velocityX *= -1;
                }
                
                if (this.invulnerable > 0) {
                    this.invulnerable--;
                }
            }
            
            attack() {
                // Shoot fireball towards Mario
                if (mario) {
                    let direction = mario.x > this.x ? 1 : -1;
                    let fireball = new Fireball(
                        this.x + this.width/2,
                        this.y + this.height/2,
                        direction
                    );
                    fireballs.push(fireball);
                }
            }
            
            takeDamage() {
                if (this.invulnerable === 0) {
                    this.health--;
                    this.invulnerable = 60;
                    createParticles(this.x + this.width/2, this.y + this.height/2, '#FF0000');
                    
                    if (this.health <= 0) {
                        score += 1000;
                        return true; // Boss defeated
                    }
                }
            }
        }
        
        // Particle class
        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.velocityX = (Math.random() - 0.5) * 10;
                this.velocityY = Math.random() * -10 - 5;
                this.life = 60;
                this.maxLife = 60;
                this.color = color;
                this.size = Math.random() * 6 + 2;
            }
            
            update() {
                this.x += this.velocityX;
                this.y += this.velocityY;
                this.velocityY += 0.3;
                this.life--;
                this.size *= 0.98; // Shrink over time
            }
            
            draw() {
                ctx.globalAlpha = this.life / this.maxLife;
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x - camera.x, this.y, this.size, this.size);
                ctx.globalAlpha = 1;
            }
        }
        
        // Create particles
        function createParticles(x, y, color) {
            for (let i = 0; i < 8; i++) {
                particles.push(new Particle(x, y, color));
            }
        }
        
        // Weather effects
        function updateWeather() {
            // Change weather randomly
            if (Math.random() < 0.001) {
                const weathers = ['sunny', 'rainy', 'snowy', 'windy'];
                weather = weathers[Math.floor(Math.random() * weathers.length)];
            }
            
            // Weather effects
            if (weather === 'rainy') {
                for (let i = 0; i < 3; i++) {
                    particles.push(new Particle(
                        camera.x + Math.random() * canvas.width,
                        -10,
                        '#4169E1'
                    ));
                }
            } else if (weather === 'snowy') {
                for (let i = 0; i < 2; i++) {
                    let snowflake = new Particle(
                        camera.x + Math.random() * canvas.width,
                        -10,
                        '#FFFFFF'
                    );
                    snowflake.velocityX = (Math.random() - 0.5) * 2;
                    snowflake.velocityY = Math.random() * 2 + 1;
                    particles.push(snowflake);
                }
            }
        }
        
        // Achievements system
        function checkAchievements() {
            const newAchievements = [];
            
            // First jump
            if (statistics.totalJumps >= 1 && !achievements.includes('first_jump')) {
                newAchievements.push('first_jump');
                showAchievement('Ø£ÙˆÙ„ Ù‚ÙØ²Ø©! ğŸ¦˜');
            }
            
            // Coin collector
            if (statistics.coinsCollected >= 100 && !achievements.includes('coin_collector')) {
                newAchievements.push('coin_collector');
                showAchievement('Ø¬Ø§Ù…Ø¹ Ø§Ù„Ø¹Ù…Ù„Ø§Øª! ğŸª™');
            }
            
            // Enemy slayer
            if (statistics.enemiesDefeated >= 50 && !achievements.includes('enemy_slayer')) {
                newAchievements.push('enemy_slayer');
                showAchievement('Ù‚Ø§ØªÙ„ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡! âš”ï¸');
            }
            
            // Level master
            if (statistics.levelsCompleted >= 3 && !achievements.includes('level_master')) {
                newAchievements.push('level_master');
                showAchievement('Ø³ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø­Ù„! ğŸ†');
            }
            
            // Speed runner
            if (timer > 350 && !achievements.includes('speed_runner')) {
                newAchievements.push('speed_runner');
                showAchievement('Ø¹Ø¯Ø§Ø¡ Ø³Ø±ÙŠØ¹! âš¡');
            }
            
            achievements.push(...newAchievements);
            if (newAchievements.length > 0) {
                localStorage.setItem('achievements', JSON.stringify(achievements));
            }
        }
        
        function showAchievement(text) {
            // Create achievement notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(45deg, #FFD700, #FFA500);
                color: #000;
                padding: 15px 25px;
                border-radius: 10px;
                font-weight: bold;
                font-size: 16px;
                z-index: 1000;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                animation: slideIn 0.5s ease-out;
            `;
            notification.textContent = `Ø¥Ù†Ø¬Ø§Ø² Ø¬Ø¯ÙŠØ¯: ${text}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Dynamic background
        function drawDynamicBackground() {
            // Sky gradient based on time of day
            let skyGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            
            switch(timeOfDay) {
                case 'day':
                    skyGradient.addColorStop(0, '#87CEEB');
                    skyGradient.addColorStop(1, '#98FB98');
                    break;
                case 'sunset':
                    skyGradient.addColorStop(0, '#FF6347');
                    skyGradient.addColorStop(0.5, '#FFD700');
                    skyGradient.addColorStop(1, '#FF69B4');
                    break;
                case 'night':
                    skyGradient.addColorStop(0, '#191970');
                    skyGradient.addColorStop(1, '#000080');
                    break;
            }
            
            ctx.fillStyle = skyGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Stars at night
            if (timeOfDay === 'night') {
                ctx.fillStyle = '#FFFFFF';
                for (let i = 0; i < 50; i++) {
                    let x = (i * 123 + camera.x * 0.1) % canvas.width;
                    let y = (i * 456) % (canvas.height / 2);
                    ctx.fillRect(x, y, 2, 2);
                }
            }
            
            // Moving clouds with parallax
            drawClouds();
            
            // Mountains in background
            ctx.fillStyle = timeOfDay === 'night' ? '#2F4F4F' : '#8FBC8F';
            for (let i = 0; i < 5; i++) {
                let x = (i * 200 - camera.x * 0.3) % (canvas.width + 200);
                let height = 100 + Math.sin(i) * 50;
                ctx.beginPath();
                ctx.moveTo(x, canvas.height - 50);
                ctx.lineTo(x + 100, canvas.height - 50 - height);
                ctx.lineTo(x + 200, canvas.height - 50);
                ctx.closePath();
                ctx.fill();
            }
        }
        
        // Initialize game
        function initGame() {
            mario = new Mario(50, 100);
            enemies = [];
            platforms = [];
            powerUps = [];
            coinItems = [];
            particles = [];
            
            // Create level
            createLevel();
        }
        
        function createLevel() {
            // Clear existing level
            platforms = [];
            enemies = [];
            powerUps = [];
            coinItems = [];
            movingPlatforms = [];
            fireballs = [];
            bosses = [];
            
            // Ground platforms for all levels
            for (let i = 0; i < 60; i++) {
                platforms.push(new Platform(i * 32, canvas.height - 50, 32, 50, 'ground'));
            }
            
            // Level-specific content
            switch(currentLevel) {
                case 1:
                    createLevel1();
                    break;
                case 2:
                    createLevel2();
                    break;
                case 3:
                    createLevel3();
                    break;
                case 4:
                    createLevel4();
                    break;
                case 5:
                    createLevel5();
                    break;
                case 6:
                    createLevel6();
                    break;
            }
        }
        
        function createLevel1() {
            // Simple level for beginners
            platforms.push(new Platform(300, 400, 128, 32, 'brick'));
            platforms.push(new Platform(500, 300, 96, 32, 'brick'));
            platforms.push(new Platform(700, 200, 128, 32, 'brick'));
            
            enemies.push(new Enemy(400, 300, 'goomba'));
            enemies.push(new Enemy(600, 200, 'goomba'));
            
            powerUps.push(new PowerUp(350, 350, 'mushroom'));
            
            for (let i = 0; i < 10; i++) {
                coinItems.push(new Coin(200 + i * 80, 150 + Math.sin(i) * 30));
            }
        }
        
        function createLevel2() {
            // More challenging with pipes
            platforms.push(new Platform(250, 450, 96, 32, 'brick'));
            platforms.push(new Platform(400, 350, 64, 32, 'brick'));
            platforms.push(new Platform(550, 250, 128, 32, 'brick'));
            platforms.push(new Platform(750, 400, 96, 32, 'brick'));
            
            platforms.push(new Platform(600, canvas.height - 150, 64, 100, 'pipe'));
            platforms.push(new Platform(900, canvas.height - 200, 64, 150, 'pipe'));
            
            enemies.push(new Enemy(300, 400, 'goomba'));
            enemies.push(new Enemy(500, 200, 'goomba'));
            enemies.push(new Enemy(800, 350, 'koopa'));
            
            powerUps.push(new PowerUp(600, 200, 'mushroom'));
            
            for (let i = 0; i < 15; i++) {
                coinItems.push(new Coin(150 + i * 70, 100 + Math.sin(i * 0.5) * 40));
            }
        }
        
        function createLevel3() {
            // Vertical challenges
            platforms.push(new Platform(200, 500, 64, 32, 'brick'));
            platforms.push(new Platform(350, 400, 64, 32, 'brick'));
            platforms.push(new Platform(500, 300, 64, 32, 'brick'));
            platforms.push(new Platform(650, 200, 64, 32, 'brick'));
            platforms.push(new Platform(800, 100, 128, 32, 'brick'));
            
            enemies.push(new Enemy(250, 450, 'goomba'));
            enemies.push(new Enemy(400, 350, 'goomba'));
            enemies.push(new Enemy(550, 250, 'koopa'));
            enemies.push(new Enemy(700, 150, 'goomba'));
            
            powerUps.push(new PowerUp(400, 350, 'mushroom'));
            powerUps.push(new PowerUp(850, 50, 'mushroom'));
            
            for (let i = 0; i < 12; i++) {
                coinItems.push(new Coin(180 + i * 90, 80 + Math.sin(i * 0.8) * 60));
            }
        }
        
        function createLevel4() {
            // Moving platforms and advanced challenges
            platforms.push(new Platform(200, 450, 96, 32, 'brick'));
            platforms.push(new Platform(600, 450, 64, 32, 'brick'));
            platforms.push(new Platform(1000, 200, 128, 32, 'brick'));
            
            // Moving platforms
            movingPlatforms.push(new MovingPlatform(350, 350, 96, 16, 300, 500, 1.5));
            movingPlatforms.push(new MovingPlatform(700, 250, 64, 16, 650, 850, 2));
            movingPlatforms.push(new MovingPlatform(1100, 400, 96, 16, 1050, 1250, 1));
            
            platforms.push(new Platform(500, canvas.height - 180, 64, 130, 'pipe'));
            platforms.push(new Platform(1200, canvas.height - 250, 64, 200, 'pipe'));
            
            enemies.push(new Enemy(250, 400, 'koopa'));
            enemies.push(new Enemy(650, 400, 'koopa'));
            enemies.push(new Enemy(1050, 150, 'koopa'));
            
            powerUps.push(new PowerUp(400, 300, 'fireFlower'));
            powerUps.push(new PowerUp(1050, 150, 'mushroom'));
            
            for (let i = 0; i < 18; i++) {
                coinItems.push(new Coin(160 + i * 75, 90 + Math.sin(i * 0.6) * 50));
            }
        }
        
        function createLevel5() {
            // Complex maze-like level
            platforms.push(new Platform(150, 500, 128, 32, 'brick'));
            platforms.push(new Platform(350, 400, 64, 32, 'brick'));
            platforms.push(new Platform(500, 500, 64, 32, 'brick'));
            platforms.push(new Platform(650, 350, 96, 32, 'brick'));
            platforms.push(new Platform(450, 250, 128, 32, 'brick'));
            platforms.push(new Platform(750, 150, 96, 32, 'brick'));
            platforms.push(new Platform(950, 300, 128, 32, 'brick'));
            
            platforms.push(new Platform(300, canvas.height - 200, 64, 150, 'pipe'));
            platforms.push(new Platform(800, canvas.height - 180, 64, 130, 'pipe'));
            platforms.push(new Platform(1150, canvas.height - 220, 64, 170, 'pipe'));
            
            enemies.push(new Enemy(200, 450, 'goomba'));
            enemies.push(new Enemy(400, 350, 'koopa'));
            enemies.push(new Enemy(550, 450, 'goomba'));
            enemies.push(new Enemy(700, 300, 'koopa'));
            enemies.push(new Enemy(500, 200, 'goomba'));
            enemies.push(new Enemy(800, 100, 'koopa'));
            enemies.push(new Enemy(1000, 250, 'goomba'));
            
            powerUps.push(new PowerUp(200, 450, 'mushroom'));
            powerUps.push(new PowerUp(700, 300, 'mushroom'));
            powerUps.push(new PowerUp(1000, 250, 'mushroom'));
            
            for (let i = 0; i < 25; i++) {
                coinItems.push(new Coin(120 + i * 60, 70 + Math.sin(i * 0.4) * 70));
            }
        }
        
        function createLevel6() {
            // Final boss level - most challenging
            platforms.push(new Platform(100, 450, 96, 32, 'brick'));
            platforms.push(new Platform(250, 350, 64, 32, 'brick'));
            platforms.push(new Platform(400, 450, 64, 32, 'brick'));
            platforms.push(new Platform(550, 300, 96, 32, 'brick'));
            platforms.push(new Platform(700, 200, 64, 32, 'brick'));
            platforms.push(new Platform(850, 350, 128, 32, 'brick'));
            platforms.push(new Platform(1050, 150, 96, 32, 'brick'));
            platforms.push(new Platform(1200, 400, 128, 32, 'brick'));
            
            // Moving platforms for extra challenge
            movingPlatforms.push(new MovingPlatform(450, 250, 64, 16, 400, 600, 2));
            movingPlatforms.push(new MovingPlatform(950, 300, 96, 16, 900, 1100, 1.5));
            
            platforms.push(new Platform(350, canvas.height - 220, 64, 170, 'pipe'));
            platforms.push(new Platform(650, canvas.height - 180, 64, 130, 'pipe'));
            platforms.push(new Platform(1000, canvas.height - 250, 64, 200, 'pipe'));
            platforms.push(new Platform(1400, canvas.height - 300, 64, 250, 'pipe'));
            
            // Boss battle
            bosses.push(new Boss(1500, canvas.height - 150, 'bowser'));
            
            enemies.push(new Enemy(150, 400, 'koopa'));
            enemies.push(new Enemy(300, 300, 'goomba'));
            enemies.push(new Enemy(600, 250, 'goomba'));
            enemies.push(new Enemy(750, 150, 'koopa'));
            enemies.push(new Enemy(900, 300, 'goomba'));
            enemies.push(new Enemy(1100, 100, 'koopa'));
            
            powerUps.push(new PowerUp(300, 300, 'fireFlower'));
            powerUps.push(new PowerUp(750, 150, 'mushroom'));
            powerUps.push(new PowerUp(1100, 100, 'fireFlower'));
            
            for (let i = 0; i < 30; i++) {
                coinItems.push(new Coin(100 + i * 55, 60 + Math.sin(i * 0.3) * 80));
            }
        }
        
        // Game loop
        function gameLoop() {
            if (gameState === 'playing') {
                // Update statistics
                statistics.timePlayed++;
                
                // Update weather and time
                updateWeather();
                if (Math.random() < 0.0005) {
                    const times = ['day', 'sunset', 'night'];
                    timeOfDay = times[Math.floor(Math.random() * times.length)];
                }
                
                // Update game objects
                mario.update();
                
                enemies.forEach(enemy => enemy.update());
                powerUps.forEach(powerUp => powerUp.update());
                coinItems.forEach(coin => coin.update());
                
                // Update moving platforms
                movingPlatforms.forEach(platform => platform.update());
                
                // Update fireballs
                for (let i = fireballs.length - 1; i >= 0; i--) {
                    fireballs[i].update();
                    if (fireballs[i].life <= 0) {
                        fireballs.splice(i, 1);
                    }
                }
                
                // Update bosses
                for (let i = bosses.length - 1; i >= 0; i--) {
                    bosses[i].update();
                    
                    // Boss collision with Mario
                    let boss = bosses[i];
                    if (mario.x < boss.x + boss.width &&
                        mario.x + mario.width > boss.x &&
                        mario.y < boss.y + boss.height &&
                        mario.y + mario.height > boss.y) {
                        
                        if (mario.velocityY > 0 && mario.y < boss.y) {
                            // Jump on boss
                            if (boss.takeDamage()) {
                                bosses.splice(i, 1);
                                score += 1000;
                                createParticles(boss.x + boss.width/2, boss.y + boss.height/2, '#FFD700');
                            }
                            mario.velocityY = -15;
                        } else if (mario.invulnerable === 0 && mario.shieldTime === 0) {
                            // Take damage from boss
                            if (mario.big) {
                                mario.big = false;
                                mario.height = 32;
                                mario.invulnerable = 120;
                            } else {
                                mario.die();
                            }
                        }
                    }
                    
                    // Fireball collision with boss
                    for (let j = fireballs.length - 1; j >= 0; j--) {
                        let fireball = fireballs[j];
                        if (fireball.x < boss.x + boss.width &&
                            fireball.x + fireball.width > boss.x &&
                            fireball.y < boss.y + boss.height &&
                            fireball.y + fireball.height > boss.y) {
                            
                            if (boss.takeDamage()) {
                                bosses.splice(i, 1);
                                score += 1000;
                                createParticles(boss.x + boss.width/2, boss.y + boss.height/2, '#FFD700');
                            }
                            fireballs.splice(j, 1);
                        }
                    }
                }
                
                // Update particles
                for (let i = particles.length - 1; i >= 0; i--) {
                    particles[i].update();
                    if (particles[i].life <= 0) {
                        particles.splice(i, 1);
                    }
                }
                
                // Update timer
                if (Math.random() < 0.01) {
                    timer--;
                    if (timer <= 0) {
                        mario.die();
                    }
                }
                
                // Draw everything
                drawDynamicBackground();
                
                // Draw game objects
                movingPlatforms.forEach(platform => platform.draw());
                platforms.forEach(platform => platform.draw());
                enemies.forEach(enemy => enemy.draw());
                bosses.forEach(boss => boss.draw());
                powerUps.forEach(powerUp => powerUp.draw());
                coinItems.forEach(coin => coin.draw());
                fireballs.forEach(fireball => fireball.draw());
                particles.forEach(particle => particle.draw());
                mario.draw();
                
                // Draw weather overlay
                if (weather === 'rainy') {
                    ctx.fillStyle = 'rgba(0, 0, 139, 0.1)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                } else if (weather === 'snowy') {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
                
                // Update UI
                document.getElementById('score').textContent = `Ø§Ù„Ù†Ù‚Ø§Ø·: ${score}`;
                document.getElementById('lives').textContent = `Ø§Ù„Ø£Ø±ÙˆØ§Ø­: ${lives}`;
                document.getElementById('timer').textContent = `Ø§Ù„ÙˆÙ‚Øª: ${timer}`;
                document.getElementById('coins').textContent = `Ø§Ù„Ø¹Ù…Ù„Ø§Øª: ${coins}`;
                
                // Save statistics periodically
                if (statistics.timePlayed % 300 === 0) {
                    localStorage.setItem('statistics', JSON.stringify(statistics));
                }
                
                // Check win condition
                if (mario.x > 1800) {
                    completeLevel();
                }
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        function completeLevel() {
            score += timer * 50;
            totalCoins += coins;
            localStorage.setItem('totalCoins', totalCoins);
            
            if (currentLevel >= maxLevel) {
                maxLevel = currentLevel + 1;
                localStorage.setItem('maxLevel', maxLevel);
            }
            
            gameState = 'levelComplete';
            document.getElementById('levelScore').textContent = `Ø§Ù„Ù†Ù‚Ø§Ø·: ${score}`;
            document.getElementById('coinsEarned').textContent = `Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©: ${coins}`;
            document.getElementById('levelComplete').classList.remove('hidden');
            
            // Reset upgrades for next level
            playerUpgrades = {
                extraMushroom: false,
                speedBoost: false,
                jumpBoost: false,
                shield: false,
                coinMultiplier: false
            };
        }
        
        function buyItem(item, price) {
            if (totalCoins >= price) {
                totalCoins -= price;
                localStorage.setItem('totalCoins', totalCoins);
                
                switch(item) {
                    case 'extraMushroom':
                        mario.startBig = true;
                        break;
                    case 'extraLife':
                        lives++;
                        break;
                    case 'speedBoost':
                        mario.speedBoost = true;
                        break;
                    case 'jumpBoost':
                        mario.jumpBoost = true;
                        break;
                    case 'shield':
                        mario.shield = true;
                        mario.shieldTime = Date.now() + 30000;
                        break;
                    case 'coinMultiplier':
                        mario.coinMultiplier = 2;
                        break;
                    case 'fireFlower':
                        mario.fireFlower = true;
                        mario.big = true;
                        mario.height = 48;
                        break;
                }
                
                updateShopUI();
                return true;
            }
            return false;
        }
        
        function updateShopUI() {
            document.getElementById('playerCoins').textContent = `Ø§Ù„Ø¹Ù…Ù„Ø§Øª: ${totalCoins}`;
            
            // Update buy buttons
            document.querySelectorAll('.buy-btn').forEach(btn => {
                const price = parseInt(btn.dataset.price);
                btn.disabled = totalCoins < price;
                btn.style.opacity = totalCoins < price ? '0.5' : '1';
            });
        }
        
        function updateLevelButtons() {
            const levelButtons = document.querySelectorAll('.level-btn');
            levelButtons.forEach((btn, index) => {
                const level = index + 1;
                btn.disabled = level > maxLevel;
                btn.style.opacity = level > maxLevel ? '0.5' : '1';
                if (level === currentLevel) {
                    btn.style.background = '#FF6B35';
                } else {
                    btn.style.background = level <= maxLevel ? '#4CAF50' : '#666';
                }
            });
        }
        
        function drawClouds() {
            ctx.fillStyle = '#FFFFFF';
            for (let i = 0; i < 5; i++) {
                let x = (i * 300 - camera.x * 0.5) % (canvas.width + 100);
                let y = 50 + i * 30;
                
                // Cloud body
                ctx.fillRect(x, y, 80, 40);
                ctx.fillRect(x + 20, y - 10, 40, 60);
                ctx.fillRect(x + 10, y + 10, 60, 20);
            }
        }
        
        // Event listeners
        document.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            e.preventDefault();
        });
        
        document.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });
        
        // Initialize saved data
        maxLevel = parseInt(localStorage.getItem('maxLevel')) || 1;
        
        // Menu event listeners
        document.getElementById('startBtn').addEventListener('click', () => {
            currentLevel = 1;
            startLevel();
        });
        
        document.getElementById('levelsBtn').addEventListener('click', () => {
            gameState = 'levelSelect';
            document.getElementById('gameMenu').classList.add('hidden');
            document.getElementById('levelSelect').classList.remove('hidden');
            updateLevelButtons();
        });
        
        document.getElementById('shopMenuBtn').addEventListener('click', () => {
            gameState = 'shop';
            document.getElementById('gameMenu').classList.add('hidden');
            document.getElementById('shop').classList.remove('hidden');
            updateShopUI();
        });
        
        document.getElementById('instructionsBtn').addEventListener('click', () => {
            document.getElementById('gameMenu').classList.add('hidden');
            document.getElementById('instructions').classList.remove('hidden');
        });
        
        document.getElementById('backBtn').addEventListener('click', () => {
            document.getElementById('instructions').classList.add('hidden');
            document.getElementById('gameMenu').classList.remove('hidden');
        });
        
        // Level selection listeners
        document.getElementById('backToMenuBtn').addEventListener('click', () => {
            gameState = 'menu';
            document.getElementById('levelSelect').classList.add('hidden');
            document.getElementById('gameMenu').classList.remove('hidden');
        });
        
        document.querySelectorAll('.level-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const level = parseInt(btn.dataset.level);
                if (level <= maxLevel) {
                    currentLevel = level;
                    startLevel();
                }
            });
        });
        
        function showShop() {
            gameState = 'shop';
            document.getElementById('gameCanvas').style.display = 'none';
            document.getElementById('gameUI').style.display = 'none';
            document.getElementById('shopMenu').style.display = 'block';
            
            // Update shop display
            document.getElementById('totalCoins').textContent = totalCoins;
            
            // Update button states based on affordability
            const buttons = document.querySelectorAll('#shopMenu button');
            buttons.forEach(button => {
                const cost = parseInt(button.getAttribute('data-cost'));
                if (totalCoins < cost) {
                    button.disabled = true;
                    button.style.opacity = '0.5';
                } else {
                    button.disabled = false;
                    button.style.opacity = '1';
                }
            });
        }
        
        // Shop listeners
        document.getElementById('backFromShopBtn').addEventListener('click', () => {
            gameState = 'menu';
            document.getElementById('shop').classList.add('hidden');
            document.getElementById('gameMenu').classList.remove('hidden');
        });
        
        document.querySelectorAll('.buy-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const item = btn.dataset.item;
                const price = parseInt(btn.dataset.price);
                if (buyItem(item, price)) {
                    btn.textContent = 'ØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡ âœ“';
                    btn.disabled = true;
                    btn.style.background = '#4CAF50';
                }
            });
        });
        
        // Level complete listeners
        document.getElementById('nextLevelBtn').addEventListener('click', () => {
            if (currentLevel < 6) {
                currentLevel++;
                startLevel();
            } else {
                alert('Ù…Ø¨Ø±ÙˆÙƒ! Ù„Ù‚Ø¯ Ø£Ù†Ù‡ÙŠØª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø­Ù„! ğŸ‰');
                gameState = 'menu';
                document.getElementById('levelComplete').classList.add('hidden');
                document.getElementById('gameMenu').classList.remove('hidden');
            }
        });
        
        document.getElementById('shopBtn').addEventListener('click', () => {
            gameState = 'shop';
            document.getElementById('levelComplete').classList.add('hidden');
            document.getElementById('shop').classList.remove('hidden');
            updateShopUI();
        });
        
        document.getElementById('levelSelectBtn').addEventListener('click', () => {
            gameState = 'levelSelect';
            document.getElementById('levelComplete').classList.add('hidden');
            document.getElementById('levelSelect').classList.remove('hidden');
            updateLevelButtons();
        });
        
        // Game over listeners
        document.getElementById('restartBtn').addEventListener('click', () => {
            startLevel();
        });
        
        document.getElementById('menuBtn').addEventListener('click', () => {
            gameState = 'menu';
            document.getElementById('gameOver').classList.add('hidden');
            document.getElementById('gameMenu').classList.remove('hidden');
        });
        
        function startLevel() {
            gameState = 'playing';
            score = 0;
            lives = 3;
            coins = 0;
            timer = 400;
            camera = { x: 0, y: 0 };
            initGame();
            
            // Hide all menus
            document.querySelectorAll('.menu').forEach(menu => {
                menu.classList.add('hidden');
            });
        }
        
        // Start game loop
        gameLoop();
    </script>
</body>
</html>
